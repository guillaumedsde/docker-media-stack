# THE MEDIA STACK #
# this docker-compose file will get a selection of media downloading/management webapps
# I've tried to simplify getting started as much as possible
#   1. configure your desired variables in the .env file
#   2. run `docker-compose up -d` from the folder with this docker-copose.yml folder
# NOTE this process is not fully automated and individual configuration of webapps is still required after docker compose
version: "2.4"

# basic common configuration for most containers
x-conf: &conf
  TZ: ${TZ}
  PGID: ${GID}
  PUID: ${UID}

# container restart policy
x-restart: &restart
  restart: always

# container logging policy
x-logging: &logging
  logging:
    driver: "json-file"
    options:
      max-file: "5"
      max-size: "10m"

# Traefik
x-traefik: &traefik
  traefik.enable: "true"

services:
  # reverse proxy
  traefik:
    image: traefik:v2.4
    depends_on:
      - traefik-socket-proxy
    user: ${UID}:${GID}
    command:
      - "--log.level=INFO"
      # docker configuration
      - "--providers.docker.endpoint=tcp://traefik-socket-proxy:2375"
      - "--providers.docker.network=traefik"
      - "--providers.docker.exposedbydefault=false"
      # entrypoints
      - "--entrypoints.web.address=:8080"
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.websecure.address=:4443"
      - "--entrypoints.websecure.http.tls.certResolver=le"
      - "--entrypoints.websecure.http.middlewares=securityHeaders@file"
      # DNS challenge
      - "--certificatesresolvers.le=true"
      - "--certificatesresolvers.le.acme.storage=/traefik/acme.json"
      - "--certificatesresolvers.le.acme.dnschallenge=true"
      - "--certificatesresolvers.le.acme.dnschallenge.delayBeforeCheck=240"
      - "--certificatesresolvers.le.acme.dnschallenge.provider=ovh"
      - "--certificatesresolvers.le.acme.email=${letsencrypt_email}"
      - "--certificatesresolvers.le.acme.keytype=EC384"
      - "--certificatesresolvers.le.acme.dnsChallenge.resolvers=1.1.1.1:53"
      # configs
      - "--providers.file.directory=/config/"
      # traefik API and dashboard
      - "--api=true"
      - "--api.dashboard=true"
      # traefik healthcheck
      - "--ping=true"
      - "--ping.manualrouting=true"
      # traefik access logs
      - "--accesslog=true"
      - "--accesslog.filepath=/var/log/traefik/access.log"
      - "--accesslog.bufferingsize=100"
      - "--accesslog.fields.headers.defaultmode=drop"
      - "--accesslog.fields.headers.names.User-Agent=keep"
      - "--accesslog.fields.headers.names.accept=keep"
      - "--accesslog.fields.headers.names.Referer=accept-language"
      - "--accesslog.fields.headers.names.Referer=keep"
    environment:
      OVH_ENDPOINT: ${OVH_ENDPOINT}
      OVH_APPLICATION_KEY: ${OVH_APPLICATION_KEY}
      OVH_APPLICATION_SECRET: ${OVH_APPLICATION_SECRET}
      OVH_CONSUMER_KEY: ${OVH_CONSUMER_KEY}
    labels:
      <<: *traefik
      traefik.http.routers.dashboard.rule: Host(`traefik.${root_domain}`)
      traefik.http.routers.dashboard.service: api@internal
      traefik.http.routers.dashboard.middlewares: traefik-forward-auth
      traefik.http.routers.ping.rule: Host(`ping.${root_domain}`)
      traefik.http.routers.ping.service: ping@internal
      traefik.http.middlewares.old-domain-redirect.redirectregex.regex: ^(http|https)://((?!jellyfin).*).${old_root_domain}/(.*)
      traefik.http.middlewares.old-domain-redirect.redirectregex.replacement: $${1}://$${2}.${root_domain}/$${3}
    read_only: true
    volumes:
      - ${docker_data_folder}/traefik/logs:/var/log/traefik/
      - ${docker_data_folder}/traefik:/traefik
      - ./config/traefik:/config:ro
    tmpfs:
      - "/var"
      - "/run"
      - "/tmp"
    networks:
      - traefik-socket-proxy
      - traefik
      - kibana
      - calibre-web
      - homer
      - gollum
      - unmanic
      - ytdl
      - ghost
      - nextcloud-proxy
      - huginn-proxy
      - gotify
      - robots
      - netdata
      - lam
      - keycloak-proxy
    <<: *restart
    <<: *logging
    mem_limit: 200m
    cpus: "4"
    ports:
      - 80:8080
      - 443:4443

  # Traefik docker socket proxy
  traefik-socket-proxy:
    image: tecnativa/docker-socket-proxy:0.1
    <<: *restart
    <<: *logging
    mem_limit: 100m
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      CONTAINERS: "1"
    networks:
      - traefik-socket-proxy
    privileged: true

  # watchtower container to update images
  # NOTE to update the containers images' watchtower needs to restart the containers this implies some downtime when it does
  # NOTE watchtower also updates itself
  watchtower:
    image: containrrr/watchtower:latest
    <<: *restart
    <<: *logging
    mem_limit: 100m
    cpus: "1"
    read_only: true
    user: ${UID}:${docker_group_id}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      WATCHTOWER_NOTIFICATIONS: "gotify"
      WATCHTOWER_NOTIFICATION_GOTIFY_URL: "${WATCHTOWER_NOTIFICATION_GOTIFY_URL}"
      WATCHTOWER_NOTIFICATION_GOTIFY_TOKEN: "${WATCHTOWER_NOTIFICATION_GOTIFY_TOKEN}"
    networks:
      - watchtower
    command: ["--cleanup", "--schedule", "0 0 5 * * *"]

  # Torrent client
  qbittorrent:
    <<: *restart
    <<: *logging
    cap_add:
      - NET_ADMIN
    volumes:
      - ${docker_data_folder}/qbittorrent-openvpn:/config
      - ${data_folder}:/data
      - torrent-blackhole:/blackhole
      - /etc/localtime:/etc/localtime:ro
    cpus: 2.0
    mem_limit: 2g
    networks:
      - traefik
    environment:
      <<: *conf
      OPENVPN_PROVIDER: WINDSCRIBE
      OPENVPN_CONFIG: Paris-Seine-udp
      OPENVPN_USERNAME: ${openvpn_user}
      OPENVPN_PASSWORD: ${openvpn_password}
      LAN: 192.168.0.0/24
      DNS: "192.168.0.1"
    labels:
      <<: *traefik
      # qBittorrent
      # service
      traefik.http.services.qbittorrent.loadbalancer.server.port: "8080"
      # router
      traefik.http.routers.qbittorrent.rule: Host(`torrent.${root_domain}`)
      traefik.http.routers.qbittorrent.service: qbittorrent
      # Forward auth
      traefik.http.routers.qbittorrent.middlewares: keycloak-forward-auth
      # Jackett
      # service
      traefik.http.services.jackett.loadbalancer.server.port: "9117"
      # Router
      traefik.http.routers.jackett.rule: Host(`jackett.${root_domain}`)
      traefik.http.routers.jackett.service: jackett
      # Forward auth
      traefik.http.routers.jackett.middlewares: keycloak-forward-auth
    image: guillaumedsde/alpine-qbittorrent-openvpn:development

  flood:
    <<: *restart
    <<: *logging
    image: jesec/flood:master-distroless
    hostname: flood.${root_domain}
    cpus: "2"
    mem_limit: 250M
    read_only: true
    user: ${UID}:${GID}
    volumes:
      - ${docker_data_folder}/flood:/config
      - ${data_folder}:/data:ro
      - /etc/localtime:/etc/localtime:ro
    networks:
      - traefik
    command:
      - --auth=none
      - --qburl=http://qbittorrent:8080
      - --qbuser=${QBT_USER}
      - --qbpass=${QBT_PASS}
      - --rundir=/config
    labels:
      <<: *traefik
      traefik.http.routers.flood.rule: Host(`flood.${root_domain}`)
      # service
      traefik.http.services.flood.loadbalancer.server.port: "3000"
      # Forward auth
      traefik.http.routers.flood.middlewares: keycloak-forward-auth

  # jackett tracker site scraper with API
  jackett:
    image: guillaumedsde/jackett-distroless:latest
    <<: *restart
    <<: *logging
    depends_on:
      qbittorrent:
        condition: service_healthy
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ${docker_data_folder}/jackett:/config
      - torrent-blackhole:/blackhole
    tmpfs:
      - "/var:rw,exec"
      - "/tmp:rw,exec"
    read_only: true
    cpus: "4"
    mem_limit: 1g
    network_mode: service:qbittorrent
    environment:
      <<: *conf
      S6_READ_ONLY_ROOT: "1"

  # Sync Jackett Indexers with Radarr, Sonarr and Lidarr
  jackett-sync-ts:
    image: allergicduck/jackett-sync
    <<: *restart
    <<: *logging
    depends_on:
      jackett:
        condition: service_healthy
      radarr:
        condition: service_started
      sonarr:
        condition: service_started
      lidarr:
        condition: service_started
    user: ${UID}:${GID}
    read_only: true
    cpus: "1"
    mem_limit: 100m
    networks:
      - traefik
    environment:
      LIDARR_URL: "http://lidarr:8686"
      LIDARR_KEY: ${LIDARR_API_KEY}
      RADARR_URL: "http://radarr:7878"
      RADARR_KEY: ${RADARR_API_KEY}
      SONARR_URL: "http://sonarr:8989"
      SONARR_KEY: ${SONARR_API_KEY}
      JACKETT_URL: "http://jackett:9117"
      JACKETT_KEY: ${JACKETT_API_KEY}

  # jackett tracker site scraper with API
  hydra:
    image: guillaumedsde/nzbhydra2-distroless:latest
    hostname: hydra.${root_domain}
    <<: *restart
    <<: *logging
    depends_on:
      jackett:
        condition: service_healthy
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ${docker_data_folder}/hydra:/config
      - torrent-blackhole:/blackhole
    tmpfs:
      - "/var:rw,exec"
      - "/tmp:rw,exec"
    read_only: true
    mem_limit: 750m
    cpus: "2"
    networks:
      - traefik
    environment:
      <<: *conf
      S6_READ_ONLY_ROOT: 1
    labels:
      <<: *traefik
      traefik.http.routers.nzbhydra.rule: Host(`hydra.${root_domain}`)
      # service
      traefik.http.services.nzbhydra.loadbalancer.server.port: "5076"
      # Forward auth
      traefik.http.routers.nzbhydra.middlewares: keycloak-forward-auth

  # radarr, webapp for downloading movies through torrent client
  # queries are done with jackett
  radarr:
    hostname: movies.${root_domain}
    image: ghcr.io/linuxserver/radarr:nightly
    <<: *restart
    <<: *logging
    cpus: "4"
    mem_limit: 2G
    depends_on:
      jackett:
        condition: service_healthy
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ${docker_data_folder}/radarr:/config
      - ${data_folder}:/data
    networks:
      - traefik
    environment:
      <<: *conf
    labels:
      <<: *traefik
      traefik.http.routers.radarr.rule: Host(`movies.${root_domain}`)
      # service
      traefik.http.services.radarr.loadbalancer.server.port: "7878"
      # Forward auth
      traefik.http.routers.radarr.middlewares: keycloak-forward-auth

  # sonarr, webapp for downloading series through torrent client
  # queries are done with jackett
  sonarr:
    hostname: series.${root_domain}
    image: ghcr.io/linuxserver/sonarr:preview
    <<: *restart
    <<: *logging
    cpus: "4"
    mem_limit: 2G
    depends_on:
      jackett:
        condition: service_healthy
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ${docker_data_folder}/sonarr:/config
      - ${data_folder}:/data
    networks:
      - traefik
    environment:
      <<: *conf
    labels:
      <<: *traefik
      traefik.http.routers.sonarr.rule: Host(`series.${root_domain}`)
      # service
      traefik.http.services.sonarr.loadbalancer.server.port: "8989"
      # Forward auth
      traefik.http.routers.sonarr.middlewares: keycloak-forward-auth

  # lidarr, webapp for downloading music through torrent client
  # queries are done with jackett
  lidarr:
    hostname: music.${root_domain}
    image: ghcr.io/linuxserver/lidarr:preview
    <<: *restart
    <<: *logging
    cpus: "4"
    mem_limit: 1G
    depends_on:
      jackett:
        condition: service_healthy
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ${docker_data_folder}/lidarr:/config
      - ${data_folder}:/data
    networks:
      - traefik
    environment:
      <<: *conf
    labels:
      <<: *traefik
      traefik.http.routers.lidarr.rule: Host(`music.${root_domain}`)
      # service
      traefik.http.services.lidarr.loadbalancer.server.port: "8686"
      # Forward auth
      traefik.http.routers.lidarr.middlewares: keycloak-forward-auth

  # bazarr, webapp for downloading subtitles
  bazarr:
    hostname: subtitles.${root_domain}
    image: hotio/bazarr:release
    <<: *restart
    <<: *logging
    depends_on:
      - "radarr"
      - "sonarr"
    environment:
      <<: *conf
    labels:
      <<: *traefik
      traefik.http.routers.bazarr.rule: Host(`subtitles.${root_domain}`)
      # service
      traefik.http.services.bazarr.loadbalancer.server.port: "6767"
      # Forward auth
      traefik.http.routers.bazarr.middlewares: keycloak-forward-auth
    cpus: "2"
    mem_limit: 300M
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ${docker_data_folder}/bazarr:/config
      - ${data_folder}:/data
      - ./config/bazarr/sub-clean.sh:/usr/bin/sub-clean.sh
      - ./config/bazarr/chmod-custom-script.sh:/etc/cont-init.d/99-chmod-custom-script
    networks:
      - traefik

  # lazylibrarian, webapp for downloading books through torrent client
  # queries are done with jackett
  lazylibrarian:
    hostname: books.${root_domain}
    image: ghcr.io/linuxserver/lazylibrarian:latest
    <<: *restart
    <<: *logging
    mem_limit: 500M
    cpus: "2"
    depends_on:
      jackett:
        condition: service_healthy
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ${docker_data_folder}/lazylibrarian:/config
      - ${data_folder}/books:/books
      - ${data_folder}/download/books:/downloads
      - ${data_folder}:/data
    networks:
      - traefik
    environment:
      <<: *conf
      DOCKER_MODS: linuxserver/calibre-web:calibre
    labels:
      <<: *traefik
      traefik.http.routers.lazylibrarian.rule: Host(`books.${root_domain}`)
      # service
      traefik.http.services.lazylibrarian.loadbalancer.server.port: "5299"
      # Forward auth
      traefik.http.routers.lazylibrarian.middlewares: keycloak-forward-auth

  # automatically extract torrented archives
  unpackerr:
    image: golift/unpackerr
    user: ${UID}:${GID}
    read_only: true
    cpus: "4"
    mem_limit: 100m
    <<: *restart
    <<: *logging
    networks:
      - traefik
    volumes:
      - ${data_folder}:/data
    environment:
      UN_SONARR_0_URL: http://sonarr:8989
      UN_SONARR_0_API_KEY: ${SONARR_API_KEY}
      UN_SONARR_0_PATH: /data/download/series
      UN_RADARR_0_URL: http://radarr:7878
      UN_RADARR_0_API_KEY: ${RADARR_API_KEY}
      UN_RADARR_0_PATH: /data/download/series
      UN_LIDARR_0_URL: http://lidarr:8686
      UN_LIDARR_0_API_KEY: ${LIDARR_API_KEY}
      UN_LIDARR_0_PATH: /data/download/music

  # homer is a homepage container
  homer:
    hostname: ${root_domain}
    image: b4bz/homer:latest
    cpus: "1"
    mem_limit: 100m
    read_only: true
    <<: *restart
    <<: *logging
    environment:
      UID: ${UID}
      GID: ${GID}
    networks:
      - homer
    volumes:
      - ${docker_data_folder}/homer/config.yml:/www/assets/config.yml:ro
      - ${docker_data_folder}/homer/assets:/www/assets
    labels:
      <<: *traefik
      traefik.docker.network: homer
      traefik.http.routers.homer.rule: Host(`home.${root_domain}`, `${root_domain}`)
      # service
      traefik.http.services.homer.loadbalancer.server.port: "8080"

  # jellyfin media server
  jellyfin:
    hostname: jellyfin.${root_domain}
    image: jellyfin/jellyfin:latest
    user: ${UID}:${GID}
    cpus: "16"
    mem_limit: 4g
    <<: *restart
    <<: *logging
    depends_on:
      - openldap
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ${docker_data_folder}/jellyfin:/config
      - ${data_folder}:/data:ro
    networks:
      - traefik
      - ldap
    environment:
      <<: *conf
      JELLYFIN_PublishedServerUrl: https://jellyfin.${root_domain}
      #Uncomment forofficial Jellyfin image:
      JELLYFIN_DATA_DIR: /config/data
      JELLYFIN_CONFIG_DIR: /config
      JELLYFIN_LOG_DIR: /config/log
      JELLYFIN_CACHE_DIR: /config/cache
    labels:
      <<: *traefik
      traefik.http.routers.jellyfin.rule: Host(`jellyfin.${root_domain}`) || Host(`jellyfin.${old_root_domain}`)
      # service
      traefik.http.services.jellyfin.loadbalancer.server.port: "8096"

  # ombi, plex media requests
  ombi:
    hostname: ombi.${root_domain}
    image: ghcr.io/linuxserver/ombi:latest
    <<: *restart
    <<: *logging
    mem_limit: 500m
    cpus: "2"
    depends_on:
      - "sonarr"
      - "radarr"
      - "lidarr"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ${docker_data_folder}/ombi:/config
    networks:
      - traefik
    environment:
      <<: *conf
    labels:
      <<: *traefik
      traefik.http.routers.ombi.rule: Host(`ombi.${root_domain}`)
      # service
      traefik.http.services.ombi.loadbalancer.server.port: "3579"

  # calibre-web, for reading ebooks
  calibre-web:
    hostname: read.${root_domain}
    image: ghcr.io/linuxserver/calibre-web:latest
    cpus: "4"
    mem_limit: 300M
    <<: *restart
    <<: *logging
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ${docker_data_folder}/calibre-web:/config
      - ${data_folder}/books:/books
    networks:
      - calibre-web
      - ldap
    environment:
      <<: *conf
      DOCKER_MODS: linuxserver/calibre-web:calibre
    labels:
      <<: *traefik
      traefik.docker.network: calibre-web
      traefik.http.routers.calibre-web.rule: Host(`read.${root_domain}`)
      # service
      traefik.http.services.calibre-web.loadbalancer.server.port: "8083"

  # gollum for hosting documentation
  gollum:
    hostname: docs.${root_domain}
    image: cuotos/gollum-alpine:latest
    <<: *restart
    <<: *logging
    cpus: "2"
    mem_limit: 250m
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ${docker_data_folder}/gollum:/wiki
    networks:
      - gollum
    environment:
      <<: *conf
      GOLLUMARGS: "--allow-uploads dir"
    labels:
      <<: *traefik
      traefik.docker.network: gollum
      traefik.http.routers.gollum.rule: Host(`docs.${root_domain}`)
      # service
      traefik.http.services.gollum.loadbalancer.server.port: "4567"
      # Forward auth
      traefik.http.routers.gollum.middlewares: keycloak-forward-auth

  # youtube-dl for downloading videos
  youtube-dl:
    image: kmb32123/youtube-dl-server:latest
    <<: *restart
    <<: *logging
    cpus: "1"
    mem_limit: 100M
    hostname: youtube-dl.${root_domain}
    environment:
      <<: *conf
    networks:
      - ytdl
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ${data_folder}/documentaries:/youtube-dl
    labels:
      <<: *traefik
      traefik.docker.network: ytdl
      traefik.http.routers.yt-dl.rule: Host(`yt-dl.${root_domain}`)
      # service
      traefik.http.services.yt-dl.loadbalancer.server.port: "8080"
      # Forward auth
      traefik.http.routers.yt-dl.middlewares: keycloak-forward-auth

  # JS CMS
  ghost_guillaume:
    environment:
      <<: *conf
      url: "https://blog.guillaume.${secondary_tld}"
      mail__transport: SMTP
      mail__from: ghost@${root_domain}
      mail__options__service: SendGrid
      mail__options__host: smtp.sendgrid.net
      mail__options__port: "465"
      mail__options__secureConnection: "true"
      mail__options__auth__user: apikey
      mail__options__auth__pass: ${SENDGRID_PASS}
    labels:
      <<: *traefik
      traefik.docker.network: ghost
      traefik.http.routers.blog-guillaume.rule: Host(`blog.guillaume.${secondary_tld}`)
      # service
      traefik.http.services.blog-guillaume.loadbalancer.server.port: "2368"
    volumes:
      - ${docker_data_folder}/ghost_guillaume:/var/lib/ghost/content
      - /etc/localtime:/etc/localtime:ro
    networks:
      - ghost
    <<: *restart
    <<: *logging
    mem_limit: 250m
    cpus: "2"
    image: ghost:alpine

  # personal cloud
  nextcloud:
    hostname: cloud.${root_domain}
    depends_on:
      - nextcloud-postgres
      - nextcloud-redis
      - samba
      - openldap
    volumes:
      - ${docker_data_folder}/nextcloud:/var/www/html
      - ${data_folder}:/data
    networks:
      - traefik
      - nextcloud
      - nextcloud-proxy
      - ldap
      - samba
    environment:
      <<: *conf
      POSTGRES_DB: nextcloud
      POSTGRES_USER: nextcloud
      POSTGRES_PASSWORD: ${nextcloud_db_pass}
      POSTGRES_HOST: nextcloud-postgres
      REDIS_HOST: nextcloud-redis
      REDIS_HOST_PASSWORD: ${NEXTCLOUD_REDIS_PASS}
      SMTP_HOST: smtp.sendgrid.net
      SMTP_SECURE: ssl
      SMTP_PORT: "465"
      SMTP_AUTHTYPE: login
      SMTP_NAME: apikey
      SMTP_PASSWORD: ${SENDGRID_PASS}
      MAIL_FROM_ADDRESS: nextcloud
      MAIL_DOMAIN: ${root_domain}
    labels:
      <<: *traefik
      traefik.docker.network: nextcloud-proxy
      traefik.http.routers.nextcloud.rule: Host(`cloud.${root_domain}`)
      traefik.http.routers.nextcloud.middlewares: nextcloud-redirectregex
      # service
      traefik.http.services.nextcloud.loadbalancer.server.port: "80"
      traefik.http.middlewares.nextcloud-redirectregex.redirectregex.permanent: "true"
      traefik.http.middlewares.nextcloud-redirectregex.redirectregex.regex: https://cloud.${root_domain}/.well-known/(card|cal)dav
      traefik.http.middlewares.nextcloud-redirectregex.redirectregex.replacement: https://cloud.${root_domain}/remote.php/dav/
    <<: *restart
    <<: *logging
    mem_limit: 1g
    cpus: "8"
    image: guillaumedsde/nextcloud-samba:latest

  # databse for nextcloud
  nextcloud-postgres:
    cpus: "2"
    mem_limit: 250m
    environment:
      POSTGRES_PASSWORD: ${nextcloud_db_pass}
      POSTGRES_USER: nextcloud
    volumes:
      - ${docker_data_folder}/nextcloud-postgres:/var/lib/postgresql/data
    networks:
      - nextcloud
    <<: *restart
    <<: *logging
    image: postgres:12-alpine

  # cache for nextcloud
  nextcloud-redis:
    cpus: "2"
    mem_limit: 200m
    networks:
      - nextcloud
    <<: *restart
    <<: *logging
    command: redis-server --requirepass ${NEXTCLOUD_REDIS_PASS}
    image: redis:alpine

  samba:
    environment:
      SAMBA_LDAP_PASSWORD: ${LDAP_ADMIN_PASSWORD}
      SID: ${SID}
    ports:
      - "139:139"
      - "445:445"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ${docker_data_folder}/samba/nslcd.conf:/etc/nslcd.conf:ro
      - ${docker_data_folder}/samba/smb.conf:/etc/samba/smb.conf:ro
      - ${docker_data_folder}/samba/secrets.tdb:/var/lib/samba/private/secrets.tdb
      - /data/users:/data/users
    depends_on:
      - openldap
    <<: *restart
    <<: *logging
    mem_limit: 250m
    cpus: "2"
    networks:
      - samba
      - ldap
    image: guillaumedsde/samba-ldap

  ssh:
    ports:
      - "1998:2222"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ${docker_data_folder}/samba/nslcd.conf:/etc/nslcd.conf:ro
      - ${docker_data_folder}/ssh/sshd_config:/etc/ssh/sshd_config:ro
      - ${docker_data_folder}/ssh/config:/config
      - /data/users:/data/users
    read_only: true
    tmpfs:
      - /run/sshd
      - /var:rw,exec
    environment:
      S6_READ_ONLY_ROOT: "1"
    depends_on:
      - openldap
    <<: *restart
    <<: *logging
    mem_limit: 100m
    cpus: "2"
    networks:
      - ssh
      - ldap
    image: guillaumedsde/ssh-ldap

  # Web Service Discovery host daemon
  # see https://github.com/christgau/wsdd
  wsdd:
    network_mode: host
    user: ${UID}:${GID}
    read_only: true
    mem_limit: 100M
    cpus: "1"
    <<: *restart
    <<: *logging
    command: --ipv4only --verbose --hostname ${WSDD_HOSTNAME} --interface ${WSDD_INTERFACE}
    image: guillaumedsde/wsdd:latest

  # gitlab runner
  gitlab-runner:
    <<: *restart
    <<: *logging
    mem_limit: 200m
    cpus: "2"
    networks:
      - gitlab-runner
    volumes:
      - ${docker_data_folder}/gitlab-runner:/etc/gitlab-runner
      - /var/run/docker.sock:/var/run/docker.sock
    image: gitlab/gitlab-runner:alpine

  # automation platform
  huginn:
    hostname: huginn.${root_domain}
    depends_on:
      - "huginn-mariadb"
    mem_limit: 750m
    cpus: "4"
    environment:
      <<: *conf
      HUGINN_DOMAIN: huginn.${root_domain}
      HUGINN_RAILS_ENV: production
      HUGINN_INVITATION_CODE: ${HUGINN_INVITATION_CODE}
      HUGINN_DATABASE_NAME: huginn
      HUGINN_IMPORT_DEFAULT_SCENARIO_FOR_ALL_USERS: "false"
      HUGINN_DATABASE_USERNAME: root
      HUGINN_DATABASE_PASSWORD: ${HUGINN_DB_PASS}
      MYSQL_PORT_3306_TCP_ADDR: huginn-mariadb
      MYSQL_PORT_3306_TCP_PORT: "3306"
      HUGINN_DATABASE_ENCODING: utf8mb4
      HUGINN_SMTP_DOMAIN: ${root_domain}
      HUGINN_SMTP_USER_NAME: apikey
      HUGINN_SMTP_PASSWORD: ${SENDGRID_PASS}
      HUGINN_SMTP_SERVER: smtp.sendgrid.net
      HUGINN_SMTP_PORT: "465"
      HUGINN_SMTP_AUTHENTICATION: login
      HUGINN_SMTP_ENABLE_STARTTLS_AUTO: "false"
      HUGINN_SMTP_SSL: "true"
      HUGINN_EMAIL_FROM_ADDRESS: huginn@${root_domain}
    volumes:
      - ${docker_data_folder}/huginn/mysql-data:/var/lib/mysql
    networks:
      - huginn
      - huginn-proxy
    labels:
      <<: *traefik
      traefik.docker.network: huginn-proxy
      traefik.http.routers.huginn.rule: Host(`huginn.${root_domain}`)
      # service
      traefik.http.services.huginn.loadbalancer.server.port: "3000"
    <<: *restart
    <<: *logging
    image: huginn/huginn:latest

  huginn-mariadb:
    image: mariadb
    mem_limit: 250m
    cpus: "2"
    volumes:
      - ${docker_data_folder}/huginn/mysql-data:/var/lib/mysql
    networks:
      - huginn
    <<: *restart
    <<: *logging
    environment:
      MYSQL_ROOT_PASSWORD: ${HUGINN_DB_PASS}

  # Push notification service
  gotify:
    hostname: gotify.${root_domain}
    mem_limit: 100M
    cpus: "2"
    environment:
      <<: *conf
    <<: *restart
    <<: *logging
    labels:
      <<: *traefik
      traefik.docker.network: gotify
      traefik.http.routers.gotify.rule: Host(`gotify.${root_domain}`)
      # service
      traefik.http.services.gotify.loadbalancer.server.port: "80"
    volumes:
      - ${docker_data_folder}/gotify:/app/data
      - /etc/localtime:/etc/localtime:ro
    networks:
      - gotify
    image: gotify/server:latest

  robots:
    image: nginx:alpine
    read_only: true
    mem_limit: 50M
    cpus: "1"
    volumes:
      - ./config/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./config/nginx/robots.txt:/usr/share/nginx/html/robots.txt:ro
      - robots-nginx-cache:/var/cache/nginx
      - robots-nginx-pid:/var/run
    networks:
      - robots
    labels:
      <<: *traefik
      traefik.docker.network: robots
      traefik.http.routers.robots.rule: HostRegexp(`${root_domain}`,`{subhost:[a-z]+}.${root_domain}`) && Path(`/robots.txt`)
      # service
      traefik.http.services.robots.loadbalancer.server.port: "8080"

  ##################################################################
  # Monitoring

  # netdata, server monitoring
  netdata:
    hostname: status.${root_domain}
    image: netdata/netdata:latest
    <<: *restart
    <<: *logging
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ${docker_data_folder}/netdata/health_alarm_notify.conf:/etc/netdata/health_alarm_notify.conf
    networks:
      - netdata
    environment:
      <<: *conf
      PGID: ${docker_group_id}
    labels:
      <<: *traefik
      traefik.docker.network: netdata
      traefik.http.routers.netdata.rule: Host(`status.${root_domain}`)
      # service
      traefik.http.services.netdata.loadbalancer.server.port: "19999"
      # Forward auth
      traefik.http.routers.netdata.middlewares: keycloak-forward-auth
    cap_add:
      - SYS_PTRACE
    security_opt:
      - apparmor:unconfined
    mem_limit: 500m
    cpus: "2"

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.12.0
    environment:
      discovery.type: single-node
      bootstrap.memory_lock: "true"
      ES_JAVA_OPTS: -Xms1G -Xmx3G
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - ${docker_data_folder}/elasticsearch/data:/usr/share/elasticsearch/data
    networks:
      - elastic
    mem_limit: 4g
    <<: *restart
    <<: *logging

  filebeat:
    image: docker.elastic.co/beats/filebeat:7.12.0
    user: root
    mem_limit: 200m
    command: --strict.perms=false
    volumes:
      - ./config/filebeat/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
      - ${docker_data_folder}/filebeat:/usr/share/filebeat/data
      - ${docker_data_folder}/traefik/logs:/var/log/traefik/:ro
      - ${docker_data_folder}/nextcloud/data/nextcloud.log:/var/log/nextcloud.log:ro
      - /var/log/:/var/log/host/:ro
    environment:
      ELASTICSEARCH_HOST: ${ELASTICSEARCH_HOST:-elasticsearch}
      KIBANA_HOST: ${KIBANA_HOST:-kibana}
    networks:
      - elastic
    <<: *restart
    <<: *logging

  metricbeat:
    image: docker.elastic.co/beats/metricbeat:7.12.0
    user: root
    cpus: "2"
    mem_limit: 250m
    networks:
      - elastic
    volumes:
      - ./config/metricbeat/metricbeat.yml:/usr/share/metricbeat/metricbeat.yml:ro
      - ${docker_data_folder}/metricbeat/data:/usr/share/metricbeat/data
      - /proc:/hostfs/proc:ro
      - /sys/fs/cgroup:/hostfs/sys/fs/cgroup:ro
      - /:/hostfs:ro
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      ELASTICSEARCH_HOST: ${ELASTICSEARCH_HOST:-elasticsearch}
      KIBANA_HOST: ${KIBANA_HOST:-kibana}
    <<: *restart
    <<: *logging
    # disable strict permission checks
    command:
      - "--strict.perms=false"
      - "-system.hostfs=/hostfs"

  kibana:
    image: docker.elastic.co/kibana/kibana:7.12.0
    networks:
      - elastic
      - kibana
    environment:
      SERVER_NAME: kibana.${root_domain}
      ELASTICSEARCH_URL: http://elasticsearch:9200
    mem_limit: 1G
    labels:
      <<: *traefik
      traefik.http.routers.kibana.rule: Host(`kibana.${root_domain}`)
      traefik.docker.network: kibana
      # service
      traefik.http.services.kibana.loadbalancer.server.port: "5601"
      # Forward auth
      traefik.http.routers.kibana.middlewares: keycloak-forward-auth

  sonarr-exporter:
    image: onedr0p/exportarr:master
    entrypoint: ["exportarr"]
    command: ["sonarr"]
    cpus: 2.0
    mem_limit: 100m
    <<: *restart
    <<: *logging
    networks:
      - traefik
      - elastic
    environment:
      PORT: "9707"
      URL: "http://sonarr:8989"
      APIKEY: "${SONARR_API_KEY}"
      ENABLE_EPISODE_QUALITY_METRICS: "true"

  radarr-exporter:
    image: onedr0p/exportarr:master
    entrypoint: ["exportarr"]
    command: ["radarr"]
    cpus: 2.0
    mem_limit: 100m
    <<: *restart
    <<: *logging
    networks:
      - traefik
      - elastic
    environment:
      PORT: "9707"
      URL: "http://radarr:7878"
      APIKEY: "${RADARR_API_KEY}"

  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    cpus: 2.0
    mem_limit: 500m
    user: ${UID}:${GID}
    environment:
      # Used to change the verbosity of the logging
      LOG_LEVEL: info
      # Enables hcaptcha-solver => https://github.com/JimmyLaurent/hcaptcha-solver
      CAPTCHA_SOLVER: hcaptcha-solver
      # Enables CaptchaHarvester => https://github.com/NoahCardoza/CaptchaHarvester
      # CAPTCHA_SOLVER: harvester
      #- HARVESTER_ENDPOINT=https://127.0.0.1:5000/token
    network_mode: service:qbittorrent
    <<: *restart
    <<: *logging

  ##################################################################
  # Authentication

  # LDAP server
  openldap:
    hostname: ldap.${old_root_domain}
    image: osixia/openldap:latest
    mem_limit: 500m
    environment:
      HOSTNAME: ldap.${old_root_domain}
      LDAP_DOMAIN: ${old_root_domain}
      LDAP_ORGANISATION: ${LDAP_ORGANISATION}
      LDAP_ADMIN_PASSWORD: ${LDAP_ADMIN_PASSWORD}
      LDAP_TLS: "true"
      LDAP_TLS_CRT_FILENAME: ldap.${old_root_domain}.cer
      LDAP_TLS_KEY_FILENAME: ldap.${old_root_domain}.key
      LDAP_TLS_CA_CRT_FILENAME: ca.cer
      LDAP_OPENLDAP_UID: ${UID}
      LDAP_OPENLDAP_GID: ${GID}
    command: "--copy-service --loglevel debug"
    <<: *restart
    <<: *logging
    networks:
      - ldap
    ports:
      - 389:389
      - 636:636
    volumes:
      - ${docker_data_folder}/openldap/ldap:/var/lib/ldap
      - ${docker_data_folder}/openldap/slapd.d:/etc/ldap/slapd.d
      # ubuntu path for Samba LDIF, this might be different with other distributions
      - ./ldap_templates/samba/ldif:/container/service/slapd/assets/config/bootstrap/ldif/custom/samba.ldif:ro
      # gotten from https://ubuntu.com/server/docs/samba-openldap-backend
      - ./ldap_templates/samba_indices.ldif:/container/service/slapd/assets/config/bootstrap/ldif/custom/samba_indices.ldif:ro
      - ./ldap_templates/memberof.ldif:/container/service/slapd/assets/config/bootstrap/ldif/custom/memberof.ldif:ro
      # certificates
      - ${docker_data_folder}/openldap/certs/ldap.${old_root_domain}:/container/service/slapd/assets/certs:ro

  # OpenLDAP certificate handler
  openldap-acme:
    image: guillaumedsde/acme.sh:latest
    user: ${UID}:${GID}
    mem_limit: 100m
    environment:
      OVH_AK: ${OVH_APPLICATION_KEY}
      OVH_AS: ${OVH_APPLICATION_SECRET}
      OVH_CK: ${OVH_CONSUMER_KEY}
      OVH_END_POINT: ${OVH_ENDPOINT}
    command:
      - daemon
    volumes:
      - ${docker_data_folder}/openldap/certs:/acme.sh

  # LDAP Server management web GUI
  lam:
    image: ldapaccountmanager/lam:stable
    volumes:
      - ${docker_data_folder}/lam/config.cfg:/etc/ldap-account-manager/config.cfg
      - ${docker_data_folder}/lam/lam.conf:/var/lib/ldap-account-manager/config/lam.conf
    environment:
      LAM_SKIP_PRECONFIGURE: "true"
    networks:
      - lam
      - ldap
    depends_on:
      - openldap
    <<: *restart
    <<: *logging
    mem_limit: 100m
    labels:
      <<: *traefik
      traefik.docker.network: lam
      traefik.http.routers.lam.rule: Host(`lam.${root_domain}`)
      # service
      traefik.http.services.lam.loadbalancer.server.port: "80"
      # Forward auth
      traefik.http.routers.lam.middlewares: traefik-forward-auth

  # SSO
  keycloak:
    image: jboss/keycloak:latest
    environment:
      # Technically, this could be auto-detected, but we prefer to be prescriptive
      DB_VENDOR: postgres
      DB_DATABASE: keycloak
      DB_ADDR: keycloak-db
      DB_USER: keycloak
      DB_PASSWORD: ${KEYCLOAK_DB_PASSWORD}
      KEYCLOAK_USER: admin
      KEYCLOAK_PASSWORD: ${KEYCLOAK_PASSWORD}
      # This is required to run keycloak behind traefik
      PROXY_ADDRESS_FORWARDING: "true"
      KEYCLOAK_HOSTNAME: keycloak.${root_domain}
    <<: *restart
    <<: *logging
    mem_limit: 750m
    depends_on:
      - keycloak-db
      - openldap
    volumes:
      - /etc/localtime:/etc/localtime:ro
    networks:
      - keycloak-proxy
      - ldap
      - keycloak
    labels:
      <<: *traefik
      traefik.docker.network: keycloak-proxy
      traefik.http.routers.keycloak.rule: Host(`keycloak.${root_domain}`)
      # service
      traefik.http.services.keycloak.loadbalancer.server.port: "8080"

  # DB for keycloak
  keycloak-db:
    <<: *restart
    <<: *logging
    mem_limit: 250m
    environment:
      # Tell Postgress what user/password to create
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: ${KEYCLOAK_DB_PASSWORD}
    image: postgres:12-alpine
    volumes:
      - ${docker_data_folder}/keycloak-db:/var/lib/postgresql/data
      - /etc/localtime:/etc/localtime:ro
    networks:
      - keycloak

  # OIDC forward authentication for traefik
  traefik-forward-auth:
    image: thomseddon/traefik-forward-auth:2
    <<: *restart
    <<: *logging
    mem_limit: 100m
    environment:
      PROVIDERS_GOOGLE_CLIENT_ID: ${OAUTH2_PROXY_CLIENT_ID}
      PROVIDERS_GOOGLE_CLIENT_SECRET: ${OAUTH2_PROXY_CLIENT_SECRET}
      SECRET: ${OAUTH2_PROXY_COOKIE_SECRET}
      #OIDC_ISSUER: https://accounts.google.com
      WHITELIST: "${allowed_emails}"
      AUTH_HOST: "oauth.${root_domain}"
      COOKIE_DOMAIN: "${root_domain}"
      COOKIE_NAME: _google_forward_auth
      CSRF_COOKIE_NAME: _google_forward_auth_csrf
    networks:
      - traefik
    labels:
      <<: *traefik
      # HTTP entrypoint
      traefik.http.routers.traefik-forward-auth.rule: Host(`oauth.${root_domain}`)
      # service
      traefik.http.services.traefik-forward-auth.loadbalancer.server.port: "4181"
      # Forward auth
      traefik.http.middlewares.traefik-forward-auth.forwardauth.address: http://traefik-forward-auth:4181
      traefik.http.routers.traefik-forward-auth.middlewares: traefik-forward-auth
      traefik.http.middlewares.traefik-forward-auth.forwardauth.authResponseHeaders: X-Forwarded-User

  # OIDC forward authentication for traefik
  keycloak-forward-auth:
    image: thomseddon/traefik-forward-auth:2
    <<: *restart
    <<: *logging
    mem_limit: 100m
    environment:
      PROVIDERS_OIDC_CLIENT_ID: ${KEYCLOAK_OIDC_CLIENT_ID}
      PROVIDERS_OIDC_CLIENT_SECRET: ${KEYCLOAK_OIDC_CLIENT_SECRET}
      SECRET: ${KEYCLOAK_OIDC_COOKIE_SECRET}
      PROVIDERS_OIDC_ISSUER_URL: https://keycloak.${root_domain}/auth/realms/${KEYCLOAK_REALM}
      AUTH_HOST: auth.${root_domain}
      COOKIE_DOMAIN: ${root_domain}
      DEFAULT_PROVIDER: oidc
      COOKIE_NAME: _keycloak_forward_auth
      CSRF_COOKIE_NAME: _keycloak_forward_auth_csrf
    command:
      - "--rule.jackett-api.action=allow"
      - "--rule.jackett-api.rule=Host(`jackett.${root_domain}`) && PathPrefix(`/api/{.*}`)"
      - "--rule.jackett-dl.action=allow"
      - "--rule.jackett-dl.rule=Host(`jackett.${root_domain}`) && PathPrefix(`/dl/{.*}`)"
      - "--rule.sonarr-calendar.action=allow"
      - "--rule.sonarr-calendar.rule=Host(`series.${root_domain}`) && PathPrefix(`/feed/calendar/{.*}`)"
      - "--rule.radarr-calendar.action=allow"
      - "--rule.radarr-calendar.rule=Host(`movies.${root_domain}`) && PathPrefix(`/feed/v3/calendar/{.*}`)"
      - "--rule.lidarr-calendar.action=allow"
      - "--rule.lidarr-calendar.rule=Host(`music.${root_domain}`) && PathPrefix(`/feed/v1/calendar/{.*}`)"
    networks:
      - traefik
    depends_on:
      - keycloak
    labels:
      <<: *traefik
      # HTTP entrypoint
      traefik.http.routers.keycloak-forward-auth.rule: Host(`auth.${root_domain}`)
      # service
      traefik.http.services.keycloak-forward-auth.loadbalancer.server.port: "4181"
      # Forward auth
      traefik.http.middlewares.keycloak-forward-auth.forwardauth.address: http://keycloak-forward-auth:4181
      traefik.http.routers.keycloak-forward-auth.middlewares: keycloak-forward-auth
      traefik.http.middlewares.keycloak-forward-auth.forwardauth.authResponseHeaders: X-Forwarded-User

networks:
  watchtower:
    driver: bridge
    name: watchtower
  traefik:
    driver: bridge
    name: traefik
  ldap:
    driver: bridge
    internal: true
    name: ldap
  keycloak:
    driver: bridge
    internal: true
    name: keycloak
  nextcloud:
    driver: bridge
    internal: true
    name: nextcloud
  huginn:
    driver: bridge
    internal: true
    name: huginn
  samba:
    driver: bridge
    name: samba
  ssh:
    driver: bridge
    name: ssh
  gitlab-runner:
    driver: bridge
    name: gitlab-runner
  elastic:
    driver: bridge
    internal: true
    name: elastic
  kibana:
    driver: bridge
    internal: true
    name: kibana
  calibre-web:
    driver: bridge
    name: calibre-web
  homer:
    driver: bridge
    internal: true
    name: homer
  gollum:
    driver: bridge
    internal: true
    name: gollum
  unmanic:
    driver: bridge
    internal: true
    name: unmanic
  ytdl:
    driver: bridge
    internal: true
    name: ytdl
  ghost:
    driver: bridge
    name: ghost
  nextcloud-proxy:
    driver: bridge
    name: nextcloud-proxy
  huginn-proxy:
    driver: bridge
    name: huginn-proxy
  gotify:
    driver: bridge
    internal: true
    name: gotify
  robots:
    driver: bridge
    internal: true
    name: robots
  netdata:
    driver: bridge
    internal: true
    name: netdata
  lam:
    driver: bridge
    internal: true
    name: lam
  keycloak-proxy:
    driver: bridge
    name: keycloak-proxy
  traefik-socket-proxy:
    driver: bridge
    internal: true
    name: traefik-socket-proxy

volumes:
  robots-nginx-cache:
  robots-nginx-pid:
  torrent-blackhole:
